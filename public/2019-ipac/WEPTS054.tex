% !TeX spellcheck = en_GB
% !TeX program = lualatex
%
% v 2.3  Feb 2019   Volker RW Schaa
%		# changes in the collaboration therefore updated file "jacow-collaboration.tex"
%		# all References with DOIs have their period/full stop before the DOI (after pp. or year)
%		# in the author/affiliation block all ZIP codes in square brackets removed as it was not %         understood as optional parameter and ZIP codes had bin put in brackets
%       # References to the current IPAC are changed to "IPAC'19, Melbourne, Australia"
%       # font for ‘url’ style changed to ‘newtxtt’ as it is easier to distinguish "O" and "0"
%
\documentclass[a4paper,
               %boxit,        % check whether paper is inside correct margins
               %titlepage,    % separate title page
               %refpage       % separate references
               %biblatex,     % biblatex is used
               keeplastbox,   % flushend option: not to un-indent last line in References
               %nospread,     % flushend option: do not fill with whitespace to balance columns
               %hyphens,      % allow \url to hyphenate at "-" (hyphens)
               %xetex,        % use XeLaTeX to process the file
               %luatex,       % use LuaLaTeX to process the file
               ]{jacow}
%
% ONLY FOR \footnote in table/tabular
%
\usepackage{pdfpages,multirow,ragged2e} %
\usepackage{listings}
\usepackage{fancyvrb}

\lstset{
 identifierstyle=\small, 
 commentstyle=\color{red}, 
 stringstyle=\ttfamily, 
 showstringspaces=false
 }


%
% CHANGE SEQUENCE OF GRAPHICS EXTENSION TO BE EMBEDDED
% ----------------------------------------------------
% test for XeTeX where the sequence is by default eps-> pdf, jpg, png, pdf, ...
%    and the JACoW template provides JACpic2v3.eps and JACpic2v3.jpg which
%    might generates errors, therefore PNG and JPG first
%
\makeatletter%
	\ifboolexpr{bool{xetex}}
	 {\renewcommand{\Gin@extensions}{.pdf,%
	                    .png,.jpg,.bmp,.pict,.tif,.psd,.mac,.sga,.tga,.gif,%
	                    .eps,.ps,%
	                    }}{}
\makeatother

% CHECK FOR XeTeX/LuaTeX BEFORE DEFINING AN INPUT ENCODING
% --------------------------------------------------------
%   utf8  is default for XeTeX/LuaTeX
%   utf8  in LaTeX only realises a small portion of codes
%
\ifboolexpr{bool{xetex} or bool{luatex}} % test for XeTeX/LuaTeX
 {}                                      % input encoding is utf8 by default
 {\usepackage[utf8]{inputenc}}           % switch to utf8

\usepackage[USenglish]{babel}

%
% if BibLaTeX is used
%
\ifboolexpr{bool{jacowbiblatex}}%
 {%
  \addbibresource{jacow-test.bib}
  \addbibresource{biblatex-examples.bib}
 }{}
\listfiles

%%
%%   Lengths for the spaces in the title
%%   \setlength\titleblockstartskip{..}  %before title, default 3pt
%%   \setlength\titleblockmiddleskip{..} %between title + author, default 1em
%%   \setlength\titleblockendskip{..}    %afterauthor, default 1em

\begin{document}

\title{Pyg4ometry : A Tool to Create Geometries for Geant4, BDSIM, G4Beamline and FLUKA for Particle Loss and Energy Deposit Studies}

\author{Stewart Boogert\thanks{stewart.boogert@rhul.ac.uk}, Andrey Abramov, Joshua Albrecht, \\ Gian Luigi D'Alessandro, Laurence Nevay, William Shields, Stuart Walker \\
JAI, Egham, Surrey)}
	
\maketitle

%
\begin{abstract}
Studying the energy deposits in accelerator components, mechanical supports, services, ancillary equipment and shielding requires a detailed computer readable description of the component geometry. The creation of geometries is a significant bottle neck in producing complete simulation models and reducing the effort required will provide the ability of non-experts to simulate the effects of beam losses on realistic accelerators. The paper describes a flexible and easy to use PYTHON package to create geometries usable by either Geant4 (and so BDSIM or G4Beamline) or FLUKA either from scratch or by conversion from common engineering formats, such as STEP or IGES created by industry standard CAD/CAM packages. The conversion requires an intermediate conversion to STL or similar triangular or tetrahedral tessellation description. A key capability of \verb|pyg4ometry| is to mix GDML/STEP/STL geometries and visualisation of the resulting geometry and determine if there are any geometric overlaps. An example conversion of a complex geometry is presented along with performance results for physical particle tracking of electromagnetically and hadronically produced particles using BDSIM.
\end{abstract}


\section{INTRODUCTION}
\verb|Pyg4ometry| started as an internal python scripting tool to generate beam line geometries for BDSIM. BDSIM is a Geant4 application which allows a user to rapidly create a full three dimensional model of an accelerator from an optical description. A guiding principle of BDSIM is rapid simulation of accelerator models, the MADX input format for example can be converted for use in BDSIM in minutes. Rarely described in accelerator optical descriptions is the geometry of the physical material that comprises the accelerator, beam-pipe, magnets, supports, tunnel, beam instrumentation etc. The aim of \verb|pyg4ometry| is to create a tool  in which complex geometry can be created as quickly as a generic BDSIM model. A key requirement is to be able to integrate and composite geometry sources to a single file.             

\subsection{Particle transport codes}
There are multiple different codes to simulate the transportation and physics processes of particles though accelerators and detectors, these include Geant4 \cite{geant4}, MCMPX and FLUKA \cite{fluka}. Generally accelerator codes, like MAD8, MADX, Transport etc, are interfaced to a Monte Carlo code to produce a complete simulation of beam losses. Two beam line simulation tools have been developed on the basis of Geant4, BDSIM and G4Beamline.     

\subsection{Geometry generation and GDML}
The specification in a computer readable format the geometry of the material surrounding an accelerator can be an exceedingly time consuming and error prone task. Typically either the detector or accelerator infrastructure is constructed over many years and the simulation geometry can be created over similar time scales. This does not allow for rapid simulation of a system as the burden of creating the geometry is too great. An XML based markup language Geometry Description Markup Language (GDML) is used as the file format for geometry export in \verb|pyg4ometry|.

\section{SOFTWARE IMPLEMENTATION}
\verb|Pyg4ometry| is a collection of python classes that mimic closely the C++ interface of Geant4. The aim to have all of the ``detector'' description classes implemented in python, these include geometry, materials and optical surfaces. The \verb|pyg4ometry| defined geometry can then quickly be written as a GDML file for loading into BDSIM or G4Beamline. This is a much quicker interface to a full C++ Geant4 application and any programmed geometry can be viewed quickly using VTK. \verb|Pyg4ometry| geometry can be converted to a surface triangulation using primitive mesh generation of each solid in python and a constructive solid geometry (CSG) library based on Binary Space Partitioning (BSP) trees. GDML has a simple mathematical expression language so geometries can be parametrised, this is also implemented in \verb|pyg4ometry| using ANTLR. A Python interface to the geometry primitives of Geant4 allows conversion applications to be developed from FLUKA/STEP/STL descriptions to \verb|pyg4ometry|. Finally and most importantly \verb|pyg4ometry| provides an interface to GDML, as the python interpreter performs important syntax checking of large and complex geometries. 

\section{EXAMPLES}
\subsection{Python}
A complete code example for creation a simple geometry consisting of three Iron solids is shown below. The python interfaces are so similar to Geant4 C++ interface and a user can refer to the Geant4 documentation.  
\VerbatimInput[fontsize=\small]{./examples/simple.py}
The code is divided in 6 blocks of definitions, reusable parameters, materials, solids, structure and placement, GDML IO and finally visualisation. A key difference between \verb|pyg4ometry| and Geant4 is a dedicated object known as the \verb|Registry| to store all geometry definitions which need to stored in the output file. The VTK output from this example is shown in Figure~\ref{fig:simple}, where three solids, a cube, sphere and cylinder, are placed with translations and rotations within a cubical world volume.
\begin{figure}[!htb]
   \centering
   \includegraphics*[width=.9\columnwidth]{./examples/simple.jpg}
   \caption{Example of three primitive Geant4 solids rendered in VTK.}
   \label{fig:simple}
\end{figure}

Figure \ref{fig:dipole} shows a more complex geometry example of a cavity beam position monitor and short sections of beam pipe.
\begin{figure}[!htb]
   \centering
   \includegraphics*[width=.8\columnwidth]{./examples/dipole.jpg}
   \caption{Example of a more complex geometry example, this time a cavity beam position monitor.}
   \label{fig:dipole}
\end{figure}

\subsection{Standard tessellation language (STL)}
STL file format describes a raw unstructured triangulated surface, the normal is defined by the ordering of the vertices. \verb|pyg4ometry| supports the loading 
STL files and conversion to G4TessellatedSolid. 
\VerbatimInput[fontsize=\small]{./examples/stl.py}

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=.6\columnwidth]{./examples/utahteapot.jpg}
   \caption{STL surface mesh rendered in VTK using pyg4ometry.}
   \label{fig:simple}
\end{figure}

\subsection{Computer aided design (STEP)}
Arbitrary conversion of CAD/CAM files to \verb|pyg4ometry| is a very challenging task. Typically users convert the CAD description into
an intermediate surface triangulation (such as STL described previously) and load the geometry as a G4TessellatedSolid. An interface for
loading STEP/STP files was creating using FreeCAD/OpenCASCADE. A single solid in general corresponds to a {\it part} and multiple placements 
of a solid to a {\it part assembly}.
A example of a conversion of a large STEP file to pyg4ometry/GDML is shown in Figure~\ref{fig:ea910}.
\VerbatimInput[fontsize=\small]{./examples/freecad.py}
\begin{figure}[!htb]
   \centering
   \includegraphics*[width=1.0\columnwidth]{./examples/ea9-10.jpg}
   \caption{Example a conversion from STEP file description of the shielding of the CERN East Area T9 and T10 test beam lines to GDML Each part is 
   coloured with a randomly to clearly indicate the structure of the shielding.}
   \label{fig:ea910}
\end{figure}


\section{BDSIM}

\begin{figure}[h!tb]
   \centering
   \includegraphics*[width=1.0\columnwidth]{./examples/dipole_bdsim.jpg}
   \caption{Example of geometry in Geant4/BDSIM. The example shows a 50~GeV proton interacting with the geometry material.}
   \label{fig:dipole}
\end{figure}

\section{SUMMARY AND FUTURE DEVELOPMENTS}
There any many potential enhancements that are being considered for \verb|pyg4ometry|. Given the interface matches so closely that of Geant4, 
an alternative C++ output writer can be quickly written to allow \verb|pyg4ometry| to generate C++ code which can be directly compiled into a 
Geant4 application. Although not described in this publication a FLUKA geometry loader has been written and can load large pre-existing geometries into 
\verb|pyg4ometry| and subsequently write GDML files. This is currently being refactored and will appear in the next public release of \verb|pyg4ometry|.
In addition to the FLUKA to GDML conversion, conversion of Geant4/GDML geometry to FLUKA is yet unstarted but a relatively straight forward
task. The requirement that volumes do not overlap causes a problem for the CAD/CAM (STEP) conversion to Geant4/GDML as there is no requirement 
that the parts and assemblies are not overlapping. Finally a graphical user interface (GUI) can be developed so allow users without programming 
experience to generate geometry.

\verb|Pyg4ometry| is a powerful package to rapidly develop material geometries for accelerator beam line simulations. Currently existing geometry can
be loaded from GDML, STEP, STL and FLUKA files. We introduce a new python interface to create geometry and adapt existing geometry. \verb|pyg4ometry| 
can composite geometry from multiple sources to create a complete model which can be exported directly to GDML and then can be loaded into a Geant4 
based application. Although based on GDML and Geant4 \verb|pyg4ometry| can be easily extended to other MC simulation geometry formats.  

%
% only for "biblatex"
%

\ifboolexpr{bool{jacowbiblatex}}%
	{\printbibliography}%
	{%
	% "biblatex" is not used, go the "manual" way
	
	%\begin{thebibliography}{99}   % Use for  10-99  references
	\begin{thebibliography}{9} % Use for 1-9 references
	
	\bibitem{geant4} Recent developments in Geant4, NIMA 835, pages 186-225, 2016 
	\bibitem{fluka} CERN-2005-10 (2005), 
	

	\end{thebibliography}
} % end \ifboolexpr


% for use as JACoW template the inclusion of the ANNEX parts have been commented out
% to generate the complete documentation please remove the "%" of the next two commands
% 
%%%\newpage

%@article{ALLISON2016186,
%title = "Recent developments in Geant4",
%journal = "Nuclear Instruments and Methods in Physics Research Section A: Accelerators, Spectrometers, Detectors and Associated Equipment",
%volume = "835",
%pages = "186 - 225",
%year = "2016",
%issn = "0168-9002",
%doi = "https://doi.org/10.1016/j.nima.2016.06.125",
%url = "http://www.sciencedirect.com/science/article/pii/S0168900216306957",
%author = "J. Allison and K. Amako and J. Apostolakis and P. Arce and M. Asai and T. Aso and E. Bagli and A. Bagulya and S. Banerjee and G. Barrand and B.R. Beck and A.G. Bogdanov and D. Brandt and J.M.C. Brown and H. Burkhardt and Ph. Canal and D. Cano-Ott and S. Chauvie and K. Cho and G.A.P. Cirrone and G. Cooperman and M.A. Cortés-Giraldo and G. Cosmo and G. Cuttone and G. Depaola and L. Desorgher and X. Dong and A. Dotti and V.D. Elvira and G. Folger and Z. Francis and A. Galoyan and L. Garnier and M. Gayer and K.L. Genser and V.M. Grichine and S. Guatelli and P. Guèye and P. Gumplinger and A.S. Howard and I. Hřivnáčová and S. Hwang and S. Incerti and A. Ivanchenko and V.N. Ivanchenko and F.W. Jones and S.Y. Jun and P. Kaitaniemi and N. Karakatsanis and M. Karamitros and M. Kelsey and A. Kimura and T. Koi and H. Kurashige and A. Lechner and S.B. Lee and F. Longo and M. Maire and D. Mancusi and A. Mantero and E. Mendoza and B. Morgan and K. Murakami and T. Nikitina and L. Pandola and P. Paprocki and J. Perl and I. Petrović and M.G. Pia and W. Pokorski and J.M. Quesada and M. Raine and M.A. Reis and A. Ribon and A. Ristić Fira and F. Romano and G. Russo and G. Santin and T. Sasaki and D. Sawkey and J.I. Shin and I.I. Strakovsky and A. Taborda and S. Tanaka and B. Tomé and T. Toshito and H.N. Tran and P.R. Truscott and L. Urban and V. Uzhinsky and J.M. Verbeke and M. Verderi and B.L. Wendt and H. Wenzel and D.H. Wright and D.M. Wright and T. Yamashita and J. Yarba and H. Yoshida",
%keywords = "High energy physics, Nuclear physics, Radiation, Simulation, Computing",
%abstract = "Geant4 is a software toolkit for the simulation of the passage of particles through matter. It is used by a large number of experiments and projects in a variety of application domains, including high energy physics, astrophysics and space science, medical physics and radiation protection. Over the past several years, major changes have been made to the toolkit in order to accommodate the needs of these user communities, and to efficiently exploit the growth of computing power made available by advances in technology. The adaptation of Geant4 to multithreading, advances in physics, detector modeling and visualization, extensions to the toolkit, including biasing and reverse Monte Carlo, and tools for physics and release validation are discussed here."
%}

%"FLUKA: a multi-particle transport code"
%A. Ferrari, P.R. Sala, A. Fasso`, and J. Ranft,
% CERN-2005-10 (2005), INFN/TC_05/11, SLAC-R-773

%%%\include{annexes-A4}

\end{document}
